<?php
foreach ($houses as $house) {
	echo '<div class="well">';
	echo '<a href="' . $this->url('details', array('username' => $house->getCreatedUser()->getUsername(), 'propertyType' => 'house', 'propertyId' => $house->getId())) . '">';
	echo $house->getAddress()->getHouse() . ' ' . $house->getAddress()->getVillage() . '<br />';
	echo '</a>';
	echo $house->getCost() . '<br />';
	echo $house->getType()->getTitle() . '<br />';
	echo '<br />';

	if (0 < count($rooms[$house->getId()])) {
		echo count($rooms[$house->getId()]) . ' rooms available';
		foreach ($rooms[$house->getId()] as $room) {
			echo '<br />' . $room->getCost() . ' (' . $room->getSize()->getWidth() . 'x' . $room->getSize()->getHeight() . 'x' . $room->getSize()->getLength() . ') ';
		}
	}
	?>

	<div>
		<div class="btn-group">
			<button class="btn ratePositive"><?php echo ($house->getPositiveRateNumber() > 0) ? $house->getPositiveRateNumber() : 0 ?></button>
			<button class="btn rateNegative"><?php echo ($house->getNegativeRateNumber() > 0) ? $house->getNegativeRateNumber() : 0 ?></button>
		</div>

		<div class="message"></div>

		<form method="post" onsubmit="return false;">
			<input type="hidden" name="houseId" class="houseId" value="<?php echo $house->getId() ?>" />
			<input type="hidden" name="rate" class="rateValue" value="1" />
			<input type="submit" class="btn rateButton" value="UP" />
		</form>

		<form method="post" onsubmit="return false;">
			<input type="hidden" name="houseId" class="houseId" value="<?php echo $house->getId() ?>" />
			<input type="hidden" name="rate" class="rateValue" value="0" />
			<input type="submit" class="btn rateButton" value="DOWN" />
		</form>
	</div>

	<?php
	echo '</div>';
}
?>

<?php echo $this->paginationControl($houses, 'Sliding', 'real-estate/houses-list/pagination-house-list.phtml'); ?>

<script type="text/javascript">
	jQuery(document).ready(function(){
		jQuery('.rateButton').click(function(){
			var houseId = jQuery(this).parent().find(".houseId").val();
			var rateValue = jQuery(this).parent().find(".rateValue").val();
			var message = jQuery(this).parent().parent().find('.message');
			var ratePositive = jQuery(this).parent().parent().find('.ratePositive');
			var rateNegative = jQuery(this).parent().parent().find('.rateNegative');
			jQuery.ajax({
				'url' : "<?php echo $this->url('rate') ?>",
				'type' : "POST",
				'data' : {"houseId" : houseId, "rateValue" : rateValue},
				'beforeSend' : function(){
					
				},
				'error' : function(){
					message.html('<div class="alert alert-error">ERROR</div>');
				},
				'success': function(data){
					var result =  jQuery.parseJSON(data);
					console.log(result);
					if(result.already){
						console.log(jQuery(this));
						message.html('<div class="alert alert-block">ALEADY</div>');
					}
					if(!result.loggedin){
						message.html('<div class="alert alert-block">YOU MUST LOGGIN TO VOTE, <a href="<?php echo $this->url('zfcuser/login') ?>">Login</a></div>');
					}
					if(null == (result.positive)){
						ratePositive.html('0');
					}else{
						ratePositive.html(result.positive);
					}
					
					if(null == (result.negative)){
						rateNegative.html('0');
					}else{
						rateNegative.html(result.negative);
					}
				}
			});
			console.log(houseId);
			console.log(rateValue);
		});
	});
</script>